<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>アンケート</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; background:#f8fafc; }
    .wrap { max-width: 720px; margin: 24px auto; padding: 16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius: 14px; padding:16px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
    .title { font-weight:700; font-size:18px; margin:0 0 8px; }
    .muted { color:#64748b; font-size:13px; }
    .question { margin-top:20px; font-weight:600; }
    textarea { width:100%; border-radius:10px; padding:10px; border:1px solid #cbd5e1; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #cbd5e1; background:#0ea5e9; color:#fff; cursor:pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .helper { font-size:12px; color:#94a3b8; }
  </style>

  <!-- レンダーAPIとレビュー画面を事前接続・先読み -->
  <link rel="preconnect" href="https://clinic-review-api.onrender.com" crossorigin>
  <link rel="dns-prefetch" href="https://clinic-review-api.onrender.com">
  <link rel="prefetch" href="review.html">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">アクセスして頂き、ありがとうございます。お手数ですが以下のアンケートにご協力ください</h1>
      <form id="surveyForm">
        <div class="helper muted">※ 全ての項目にお答えください <span id="progress"></span></div>

        <!-- 質問項目 -->
        <div class="question">1. 受診して良かったと思いますか？</div>
        <label><input type="radio" name="q1" value="とても良かった"> とても良かった</label>
        <label><input type="radio" name="q1" value="良かった"> 良かった</label>
        <label><input type="radio" name="q1" value="普通"> 普通</label>
        <label><input type="radio" name="q1" value="良くなかった"> 良くなかった</label>
        <label><input type="radio" name="q1" value="とても良くなかった"> とても良くなかった</label>

        <div class="question">2. その理由を教えてください</div>
        <textarea name="q2" placeholder="例）スタッフの対応が丁寧で安心できました"></textarea>

        <div class="question">3. 医師の対応はどうでしたか？</div>
        <label><input type="radio" name="q3" value="とても良かった"> とても良かった</label>
        <label><input type="radio" name="q3" value="良かった"> 良かった</label>
        <label><input type="radio" name="q3" value="普通"> 普通</label>
        <label><input type="radio" name="q3" value="良くなかった"> 良くなかった</label>
        <label><input type="radio" name="q3" value="とても良くなかった"> とても良くなかった</label>

        <div class="question">4. その理由を教えてください</div>
        <textarea name="q4" placeholder="例）説明が分かりやすく安心感がありました"></textarea>

        <div class="question">5. 受付の対応はどうでしたか？</div>
        <label><input type="radio" name="q5" value="とても良かった"> とても良かった</label>
        <label><input type="radio" name="q5" value="良かった"> 良かった</label>
        <label><input type="radio" name="q5" value="普通"> 普通</label>
        <label><input type="radio" name="q5" value="良くなかった"> 良くなかった</label>
        <label><input type="radio" name="q5" value="とても良くなかった"> とても良くなかった</label>

        <div class="question">6. その理由を教えてください</div>
        <textarea name="q6" placeholder="例）受付の方が笑顔で対応してくれました"></textarea>

        <div class="question">7. 院内の雰囲気はどうでしたか？</div>
        <label><input type="radio" name="q7" value="とても良かった"> とても良かった</label>
        <label><input type="radio" name="q7" value="良かった"> 良かった</label>
        <label><input type="radio" name="q7" value="普通"> 普通</label>
        <label><input type="radio" name="q7" value="良くなかった"> 良くなかった</label>
        <label><input type="radio" name="q7" value="とても良くなかった"> とても良くなかった</label>

        <div class="question">8. その理由を教えてください</div>
        <textarea name="q8" placeholder="例）落ち着いた雰囲気でリラックスできました"></textarea>

        <div class="question">9. 他の人に受診を勧めますか？</div>
        <label><input type="radio" name="q9" value="強く勧める"> 強く勧める</label>
        <label><input type="radio" name="q9" value="勧める"> 勧める</label>
        <label><input type="radio" name="q9" value="普通"> 普通</label>
        <label><input type="radio" name="q9" value="勧めない"> 勧めない</label>
        <label><input type="radio" name="q9" value="絶対勧めない"> 絶対勧めない</label>

        <div class="question">10. その理由を教えてください</div>
        <textarea name="q10" placeholder="例）安心して受診できると思ったため"></textarea>

        <div style="margin-top:20px;">
          <button type="submit">送信</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const API_BASE = "https://clinic-review-api.onrender.com"; // ← RenderのURLに変更可

    // ==== プレウォーム ====
    setTimeout(() => {
      fetch(`${API_BASE}/health`, { cache: "no-store" }).catch(() => {});
    }, 2000);

    // ==== 進捗表示 ====
    const form = document.getElementById("surveyForm");
    const progressEl = document.getElementById("progress");
    const radios = ["q1","q3","q5","q7","q9"];
    const texts  = ["q2","q4","q6","q8","q10"];
    const updateProgress = () => {
      const r = radios.filter(n => form.querySelector(`input[name="${n}"]:checked`)).length;
      const t = texts.filter(n => (form.querySelector(`[name="${n}"]`)?.value.trim() || "").length > 0).length;
      progressEl.textContent = `${r + t}/10`;
    };
    form.addEventListener("input", updateProgress);
    updateProgress();

    // ==== 送信処理 ====
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const getRadio = (name) => {
        const el = form.querySelector(`input[name="${name}"]:checked`);
        return el ? el.value : "";
      };
      const getText = (name) => {
        const el = form.querySelector(`[name="${name}"]`);
        return el ? el.value.trim() : "";
      };
      const answers = {
        q1: getRadio("q1"), q2: getText("q2"),
        q3: getRadio("q3"), q4: getText("q4"),
        q5: getRadio("q5"), q6: getText("q6"),
        q7: getRadio("q7"), q8: getText("q8"),
        q9: getRadio("q9"), q10: getText("q10")
      };
      const scoreMapGeneral = {
        "とても良かった": 5, "良かった": 4, "普通": 3, "良くなかった": 2, "とても良くなかった": 1
      };
      const scoreMapRecommend = {
        "強く勧める": 5, "勧める": 4, "普通": 3, "勧めない": 2, "絶対勧めない": 1
      };
      const scores = [
        scoreMapGeneral[answers.q1],
        scoreMapGeneral[answers.q3],
        scoreMapGeneral[answers.q5],
        scoreMapGeneral[answers.q7],
        scoreMapRecommend[answers.q9]
      ];
      const avg = scores.every(n => typeof n === "number") ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
      sessionStorage.setItem("clinic_answers", JSON.stringify(answers));
      if (avg >= 3.5) {
        window.location.href = "review.html";
      } else {
        window.location.href = "thanks.html";
      }
    });
  });
  </script>
</body>
</html>
